version: 2.1

orbs:
  aws-cli: circleci/aws-cli@2.0.3

jobs:
  test:
    machine:
      image: ubuntu-2004:202104-01
    working_directory: ~/data
    steps:
      - checkout
      - run: make db-start
      - run: make db-init
      - run: make db-migrate
      - run: make test
  assume-role:
    executor: aws-cli/default
    steps:
      - aws-cli/setup

workflows:
  test:
    jobs:
      - test
  deploy:
    jobs:
      - assume-role
