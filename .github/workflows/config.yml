name: pipeline
on: [push]
jobs:
  test:
    runs-on: ubuntu-latest
    env:
      DB_DROP: yes
      DB_HOST: postgres
      DB_NAME: go_server_test
      DB_USER: postgres
      DB_PASSWORD: password
      DB_PORT: 5432
      DB_SSL: false
      DB_SSL_MODE: disable
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - run: make lint-docker
      - run: make db-start
      - run: make db-init
      - run: make db-migrate
      - run: make test-docker
  deploy:
    name: deploy to aws
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
    - name: checkout
      uses: actions/checkout@v2
    - name: configure aws credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        role-to-assume: arn:aws:iam::408204130528:role/tchr_voice_github_role
        aws-region: us-east-2
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1
